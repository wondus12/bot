<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Registration - Content Bot</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 100%;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .step {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .step h3 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
        .fingerprint-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 14px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 10px 0;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: center;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .device-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .device-info h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .device-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Device Registration</h1>
        
        <div id="loginStep" class="step">
            <h3>Step 1: Telegram Authentication</h3>
            <p>First, authenticate with your Telegram account to verify your subscription.</p>
            <button class="btn" onclick="authenticateWithTelegram()">Login with Telegram</button>
        </div>
        
        <div id="fingerprintStep" class="step" style="display: none;">
            <h3>Step 2: Device Fingerprinting</h3>
            <p>We'll collect your device characteristics to create a unique fingerprint.</p>
            <div class="fingerprint-info">
                <strong>Information Collected:</strong><br>
                ‚Ä¢ Browser and OS details<br>
                ‚Ä¢ Screen resolution and timezone<br>
                ‚Ä¢ Hardware specifications<br>
                ‚Ä¢ Network characteristics
            </div>
            <button class="btn" onclick="collectFingerprint()">Collect Device Fingerprint</button>
        </div>
        
        <div id="registrationStep" class="step" style="display: none;">
            <h3>Step 3: Device Registration</h3>
            <p>Register this device for secure content access.</p>
            <div id="deviceInfo" class="device-info"></div>
            <button class="btn" onclick="registerDevice()">Register This Device</button>
        </div>
        
        <div id="statusDiv"></div>
    </div>

    <script>
        let telegramToken = null;
        let deviceFingerprint = null;
        let deviceId = null;

        // Telegram Web App integration (if running in Telegram)
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            
            // Auto-authenticate if in Telegram WebApp
            if (window.Telegram.WebApp.initDataUnsafe.user) {
                telegramToken = generateTelegramToken(window.Telegram.WebApp.initDataUnsafe);
                showStep('fingerprintStep');
                showStatus('Authenticated with Telegram', 'success');
            }
        }

        function authenticateWithTelegram() {
            // For web version, simulate Telegram login
            // In production, implement proper Telegram OAuth
            showStatus('Simulating Telegram authentication...', 'info');
            
            setTimeout(() => {
                telegramToken = 'demo_token_' + Date.now();
                showStep('fingerprintStep');
                showStatus('Authenticated successfully', 'success');
            }, 1500);
        }

        function generateTelegramToken(initData) {
            // Generate JWT token from Telegram data
            // In production, this would be done server-side
            return btoa(JSON.stringify({
                telegram_id: initData.user.id,
                username: initData.user.username,
                first_name: initData.user.first_name,
                timestamp: Date.now()
            }));
        }

        async function collectFingerprint() {
            showStatus('Collecting device fingerprint...', 'info');
            
            try {
                // Collect comprehensive browser fingerprint
                const fingerprint = await generateBrowserFingerprint();
                
                // Send to backend for device ID generation
                const response = await fetch('/api/device/fingerprint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(fingerprint)
                });
                
                const result = await response.json();
                
                if (result.device_id) {
                    deviceFingerprint = fingerprint;
                    deviceId = result.device_id;
                    
                    displayDeviceInfo(fingerprint, deviceId);
                    showStep('registrationStep');
                    showStatus('Device fingerprint collected successfully', 'success');
                } else {
                    throw new Error('Failed to generate device ID');
                }
                
            } catch (error) {
                showStatus('Failed to collect fingerprint: ' + error.message, 'error');
            }
        }

        async function generateBrowserFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint test', 2, 2);
            
            const fingerprint = {
                // Browser characteristics
                user_agent: navigator.userAgent,
                language: navigator.language,
                languages: navigator.languages,
                platform: navigator.platform,
                cookie_enabled: navigator.cookieEnabled,
                do_not_track: navigator.doNotTrack,
                
                // Screen characteristics
                screen_width: screen.width,
                screen_height: screen.height,
                screen_color_depth: screen.colorDepth,
                screen_pixel_depth: screen.pixelDepth,
                available_width: screen.availWidth,
                available_height: screen.availHeight,
                
                // Viewport
                inner_width: window.innerWidth,
                inner_height: window.innerHeight,
                outer_width: window.outerWidth,
                outer_height: window.outerHeight,
                
                // System
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                timezone_offset: new Date().getTimezoneOffset(),
                
                // Hardware
                hardware_concurrency: navigator.hardwareConcurrency,
                device_memory: navigator.deviceMemory,
                max_touch_points: navigator.maxTouchPoints,
                
                // Canvas fingerprint
                canvas_fingerprint: canvas.toDataURL(),
                
                // WebGL fingerprint
                webgl_vendor: getWebGLParameter('VENDOR'),
                webgl_renderer: getWebGLParameter('UNMASKED_RENDERER_WEBGL'),
                
                // Additional entropy
                device_type: 'laptop',
                platform_type: getPlatformType(),
                timestamp: Date.now()
            };
            
            return fingerprint;
        }

        function getWebGLParameter(parameter) {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return null;
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                if (!debugInfo) return null;
                
                return gl.getParameter(debugInfo[parameter]);
            } catch (e) {
                return null;
            }
        }

        function getPlatformType() {
            const platform = navigator.platform.toLowerCase();
            if (platform.includes('win')) return 'windows';
            if (platform.includes('mac')) return 'macos';
            if (platform.includes('linux')) return 'linux';
            return 'unknown';
        }

        function displayDeviceInfo(fingerprint, deviceId) {
            const deviceInfo = document.getElementById('deviceInfo');
            deviceInfo.innerHTML = `
                <h4>Device Information</h4>
                <p><strong>Device ID:</strong> ${deviceId.substring(0, 16)}...</p>
                <p><strong>Platform:</strong> ${fingerprint.platform_type}</p>
                <p><strong>Browser:</strong> ${fingerprint.user_agent.split(' ')[0]}</p>
                <p><strong>Screen:</strong> ${fingerprint.screen_width}x${fingerprint.screen_height}</p>
                <p><strong>Timezone:</strong> ${fingerprint.timezone}</p>
            `;
        }

        async function registerDevice() {
            if (!telegramToken || !deviceFingerprint) {
                showStatus('Missing authentication or fingerprint data', 'error');
                return;
            }
            
            showStatus('Registering device...', 'info');
            
            try {
                const registrationData = {
                    device_type: 'laptop',
                    platform: deviceFingerprint.platform_type,
                    device_name: `${deviceFingerprint.platform_type} Browser`,
                    ...deviceFingerprint
                };
                
                const response = await fetch('/api/device/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${telegramToken}`
                    },
                    body: JSON.stringify(registrationData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store device credentials securely
                    localStorage.setItem('device_id', result.device_id);
                    // Note: In production, private key should be stored in more secure storage
                    
                    showStatus(`Device registered successfully! You can now access protected content.`, 'success');
                    
                    // Hide all steps
                    document.querySelectorAll('.step').forEach(step => step.style.display = 'none');
                    
                    // Show success message with next steps
                    setTimeout(() => {
                        window.location.href = '/content-library';
                    }, 3000);
                    
                } else {
                    throw new Error(result.error || 'Registration failed');
                }
                
            } catch (error) {
                showStatus('Registration failed: ' + error.message, 'error');
            }
        }

        function showStep(stepId) {
            document.getElementById(stepId).style.display = 'block';
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Security measures
        function detectDevTools() {
            let devtools = {open: false};
            setInterval(() => {
                if (window.outerHeight - window.innerHeight > 200 || 
                    window.outerWidth - window.innerWidth > 200) {
                    if (!devtools.open) {
                        devtools.open = true;
                        console.warn('Developer tools detected');
                        // In production, could disable functionality or log security event
                    }
                } else {
                    devtools.open = false;
                }
            }, 500);
        }

        // Initialize security monitoring
        detectDevTools();
        
        // Disable right-click context menu
        document.addEventListener('contextmenu', e => e.preventDefault());
        
        // Disable common developer shortcuts
        document.addEventListener('keydown', e => {
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'C') ||
                (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
                console.warn('Developer tools access blocked');
            }
        });
    </script>
</body>
</html>
